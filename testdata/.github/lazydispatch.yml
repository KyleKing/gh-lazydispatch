version: 2
chains:
  deploy-all:
    description: Build, test, and deploy to all environments
    variables:
      - name: version
        type: string
        description: Release version (e.g., v1.0.0)
        default: v1.0.0
        required: true
      - name: release_type
        type: choice
        description: Type of release
        options: [major, minor, patch]
        default: patch
      - name: draft
        type: boolean
        description: Create as draft release
        default: "true"
    steps:
      - workflow: release.yml
        inputs:
          version: "{{ var.version }}"
          release_type: "{{ var.release_type }}"
          draft: "{{ var.draft }}"
      - workflow: deploy.yml
        wait_for: success
        inputs:
          environment: staging
          dry_run: "true"
      - workflow: deploy.yml
        wait_for: success
        on_failure: abort
        inputs:
          environment: production
          dry_run: "false"

  quick-test:
    description: Run tests with default settings
    steps:
      - workflow: deploy.yml
        wait_for: none
        inputs:
          environment: development
          dry_run: "true"

  staged-release:
    description: Deploy to staging first, then production
    variables:
      - name: environment
        type: choice
        description: Target environment
        options: [staging, production]
        default: staging
    steps:
      - workflow: deploy.yml
        wait_for: success
        on_failure: abort
        inputs:
          environment: staging
      - workflow: deploy.yml
        wait_for: success
        inputs:
          environment: production
