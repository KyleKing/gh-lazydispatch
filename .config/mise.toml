[env]
MISE_ENV = "hk"

[settings]
experimental = true

[tasks.ci]
description = "Run all checks (used in GitHub Actions)"
run = ["./scripts/check-test-safety.sh", "go test -v ./...", "go build -v ./..."]

[tasks.format]
description = "Format code with golangci-lint and golines"
run = ["golangci-lint run --fix ./...", "golines -w ."]

[tasks.hooks]
description = "Run git hooks"
run = ["hk fix --quiet"]

[tasks.test]
description = "Run tests with coverage"
run = "go test -coverprofile=coverage.out ./..."

[tasks."test:integration"]
description = "Run integration tests only"
run = "go test -v -run TestIntegration ./..."

[tasks."test:view-coverage"]
description = "View coverage report in browser"
run = ["go tool cover -html=coverage.out"]

[tasks.bench]
description = "Run benchmarks for logs package"
run = "go test -bench=. -benchmem ./internal/logs/..."

[tasks."bench:compare"]
description = "Compare benchmark results (requires old-bench.txt and new-bench.txt)"
run = "benchstat old-bench.txt new-bench.txt"

[tasks."bench:save"]
description = "Run benchmarks and save results to bench.txt"
run = "go test -bench=. -benchmem ./internal/logs/... | tee bench.txt"

[tasks.demo]
description = "Generate all VHS demo recordings in parallel"
run = """
go build -o gh-lazydispatch . && \
vhs < .github/assets/demo.tape & \
vhs < .github/assets/chains-demo.tape & \
wait
"""
